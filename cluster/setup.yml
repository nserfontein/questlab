---

- name: Rancher
  hosts: control
  vars:
    docker_version: 18.09
    docker_install_script: https://releases.rancher.com/install-docker/{{ docker_version }}.sh
    rancher_version: 2.3.4

  tasks:

    - name: Install Docker
      shell: curl {{ docker_install_script }} | sh
      args:
        creates: /usr/bin/docker

    - name: Run Rancher
      docker_container:
        name: rancher
        image: rancher/rancher:v{{ rancher_version }}
        restart_policy: unless-stopped
        ports:
          - "80:80"
          - "443:443"

- name: K3sup
  hosts: control
  become: no

  tasks:
    - name: Download k3sup
      shell: curl -sLS https://get.k3sup.dev | sh

    - name: Master
      shell: k3sup install --ip 192.168.178.205 --user node

    - name: Workers
      shell: k3sup join --ip {{ item }} --server-ip 192.168.178.205 --user $USER
      with_items:
        - 192.168.178.202
        - 192.168.178.203
